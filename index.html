<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NICU Discharge Summary Generator</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- DOCX Generation Libraries (Critical for download) -->
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;700&family=Times+New+Roman&display=swap');

        body { font-family: 'Times New Roman', Times, serif; color: black; }
        .bengali-text { font-family: 'Noto Sans Bengali', sans-serif; }

        /* Editor Styles */
        .editor-input { width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; font-family: sans-serif; font-size: 0.875rem; }
        .editor-label { display: block; font-family: sans-serif; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; color: #4b5563; margin-bottom: 0.25rem; }

        /* A4 Page Layout */
        .a4-page {
            width: 210mm; min-height: 297mm; background: white; padding: 15mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.1); margin: 0 auto; position: relative; color: black;
        }
        
        /* Layout Tables for Preview */
        table.layout-table { width: 100%; border-collapse: collapse; margin-bottom: 5px; }
        table.layout-table td { vertical-align: top; padding: 2px; }
        
        /* Data Tables */
        table.data-table { width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 5px; break-inside: avoid; page-break-inside: avoid; }
        table.data-table th, table.data-table td { border: 1px solid black; padding: 4px; text-align: center; }
        table.data-table th { background-color: #f3f4f6; font-weight: bold; }
        table.data-table td:first-child { text-align: left; font-weight: bold; }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            /* Explicitly setting padding to match .a4-page padding of 15mm to fix margins */
            #print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 15mm; box-shadow: none; }
            @page { margin: 0; size: auto; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="bg-gray-900 text-white p-4 shadow-md flex justify-between items-center no-print z-10">
        <div class="flex items-center gap-2">
            <i data-lucide="file-text"></i>
            <h1 class="text-xl font-bold font-sans">NICU Discharge Generator</h1>
        </div>
        <div class="flex gap-2">
            <!-- DOWNLOAD BUTTONS -->
            <button onclick="exportHtmlToWord()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded flex items-center gap-2 font-sans text-sm font-semibold transition shadow-lg ring-2 ring-indigo-500 ring-offset-2 ring-offset-gray-900">
                <i data-lucide="file-text"></i> Download .DOC (Simple)
            </button>
            <button onclick="generateDocx()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded flex items-center gap-2 font-sans text-sm font-semibold transition shadow-lg ring-2 ring-blue-500 ring-offset-2 ring-offset-gray-900">
                <i data-lucide="download"></i> Download .DOCX (Exact)
            </button>
            <button onclick="window.print()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded flex items-center gap-2 font-sans text-sm font-semibold transition">
                <i data-lucide="printer"></i> Print / PDF
            </button>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden">
        <!-- Editor (Left) -->
        <div class="w-full md:w-5/12 bg-white border-r border-gray-300 overflow-y-auto p-6 no-print font-sans">
            <!-- Patient Details -->
            <h2 class="text-lg font-bold mb-4 border-b pb-2">Patient Details</h2>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div><label class="editor-label">Name</label><input type="text" class="editor-input" id="in_name" value=""></div>
                <div><label class="editor-label">Age</label><input type="text" class="editor-input" id="in_age" value=""></div>
                <div><label class="editor-label">Reg No</label><input type="text" class="editor-input" id="in_reg" value=""></div>
                <div><label class="editor-label">Admission Date</label><input type="text" class="editor-input" id="in_admDate" value=""></div>
                <div><label class="editor-label">Admission Time</label><input type="text" class="editor-input" id="in_admTime" value=""></div>
                <div><label class="editor-label">Discharge Date</label><input type="text" class="editor-input" id="in_disDate" value=""></div>
                <div><label class="editor-label">Discharge Time</label><input type="text" class="editor-input" id="in_disTime" value=""></div>
                <div><label class="editor-label">BALAM</label><input type="text" class="editor-input" id="in_balam" value=""></div>
                <div><label class="editor-label">SCANU</label><input type="text" class="editor-input" id="in_scanu" value=""></div>
                <div><label class="editor-label">Mobile</label><input type="text" class="editor-input" id="in_mobile" value=""></div>
                <div><label class="editor-label">Bed Doctor</label><input type="text" class="editor-input" id="in_bedDoctor" value=""></div>
                <div class="col-span-2"><label class="editor-label">Address</label><input type="text" class="editor-input" id="in_address" value=""></div>
                <div><label class="editor-label">Mother's Name</label><input type="text" class="editor-input" id="in_mother" value=""></div>
                <div><label class="editor-label">Father's Name</label><input type="text" class="editor-input" id="in_father" value=""></div>
                <div class="col-span-2"><label class="editor-label">Consultant</label><input type="text" class="editor-input" id="in_consultant" value=""></div>
            </div>

            <h2 class="text-lg font-bold mb-4 border-b pb-2">Clinical Info</h2>
            <div class="mb-4">
                <label class="editor-label">Diagnosis</label>
                <textarea id="in_diagnosis" class="editor-input h-20"></textarea>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                 <div><label class="editor-label">Discharge Status</label><input type="text" class="editor-input" id="in_disStatus" value=""></div>
                 <div><label class="editor-label">Discharge Type</label><input type="text" class="editor-input" id="in_disType" value=""></div>
                 <div><label class="editor-label">Discharge Weight</label><input type="text" class="editor-input" id="in_disWeight" value=""></div>
                 <div><label class="editor-label">Discharge Length</label><input type="text" class="editor-input" id="in_disLength" value=""></div>
                 <div><label class="editor-label">Discharge OFC</label><input type="text" class="editor-input" id="in_disOFC" value=""></div>
            </div>

            <div class="mb-6">
                <label class="editor-label">Brief Clinical History</label>
                <textarea id="in_history" class="editor-input h-32"></textarea>
            </div>

            <h2 class="text-lg font-bold mb-4 border-b pb-2">General Info & Treatment</h2>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><label class="editor-label">Baby Color</label><input type="text" class="editor-input" id="in_babyColor" value=""></div>
                <div><label class="editor-label">Reflex</label><input type="text" class="editor-input" id="in_babyReflex" value=""></div>
                <div><label class="editor-label">Pulse</label><input type="text" class="editor-input" id="in_pulse" value=""></div>
                <div><label class="editor-label">Resp. Rate</label><input type="text" class="editor-input" id="in_resp" value=""></div>
                <div><label class="editor-label">Birth Weight</label><input type="text" class="editor-input" id="in_birthWeight" value=""></div>
                <div><label class="editor-label">Blood Group</label><input type="text" class="editor-input" id="in_bloodGroup" value=""></div>
                <div><label class="editor-label">Mother Age</label><input type="text" class="editor-input" id="in_motherAge" value=""></div>
                <div><label class="editor-label">Mother Para</label><input type="text" class="editor-input" id="in_motherPara" value=""></div>
            </div>

            <div class="mb-6">
                <label class="editor-label">Treatment Summary</label>
                <textarea id="in_treatment" class="editor-input h-32"></textarea>
            </div>

            <h2 class="text-lg font-bold mb-4 border-b pb-2">Investigations Table</h2>
             <div class="bg-gray-50 p-3 rounded border border-gray-200 mb-4">
                <label class="editor-label">Controls</label>
                <div class="flex gap-2 flex-wrap mb-3">
                    <button onclick="addRow()" class="bg-blue-100 text-blue-800 px-3 py-1 rounded text-xs font-bold hover:bg-blue-200 border border-blue-200">+ Add Row</button>
                    <button onclick="addColumn()" class="bg-blue-100 text-blue-800 px-3 py-1 rounded text-xs font-bold hover:bg-blue-200 border border-blue-200">+ Add Col</button>
                    <button onclick="deleteRow()" class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded text-xs font-bold hover:bg-yellow-200 border border-yellow-200">- Del Row</button>
                    <button onclick="deleteColumn()" class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded text-xs font-bold hover:bg-yellow-200 border border-yellow-200">- Del Col</button>
                    <button onclick="clearTable()" class="bg-red-100 text-red-700 px-3 py-1 rounded text-xs font-bold hover:bg-red-200 border border-red-200">Clear Table</button>
                    <button onclick="newPatient()" class="bg-gray-200 text-gray-700 px-3 py-1 rounded text-xs font-bold hover:bg-gray-300 border border-gray-300">New Patient / Reset</button>
                </div>
                
                <label class="editor-label">Paste Excel Data</label>
                <div class="flex gap-2">
                    <textarea id="paste-area" class="editor-input h-16 text-xs font-mono" placeholder="Copy table from Excel and paste here..."></textarea>
                    <button onclick="importTable()" class="bg-emerald-600 text-white px-4 py-1 rounded text-xs font-bold hover:bg-emerald-700 whitespace-nowrap self-start h-16">Import</button>
                </div>
            </div>
            <div class="overflow-x-auto mb-6">
                <table id="editor-table" class="w-full text-xs border border-gray-300"></table>
            </div>

            <h2 class="text-lg font-bold mb-4 border-b pb-2">Advice & Follow Up</h2>
            <div class="mb-4">
                <label class="editor-label">Advice (Bengali/English)</label>
                <textarea id="in_advice" class="editor-input h-32"></textarea>
            </div>
            <div class="mb-4">
                <label class="editor-label">OPD Follow Up</label>
                <textarea id="in_opd" class="editor-input h-16"></textarea>
            </div>
             <div class="mb-4">
                <label class="editor-label">NICU Contact No</label>
                <input type="text" class="editor-input" id="in_contact" value="">
            </div>

             <div class="grid grid-cols-2 gap-4 mb-20">
                <div><label class="editor-label">Prepared By</label><input type="text" class="editor-input" id="in_prepBy" value=""></div>
                <div><label class="editor-label">Checked By</label><input type="text" class="editor-input" id="in_checkBy" value=""></div>
            </div>
        </div>

        <!-- Preview (Right) -->
        <div class="w-full md:w-7/12 bg-gray-500 overflow-y-auto p-8 flex justify-center">
            <div id="print-area" class="a4-page text-xs leading-tight">
                
                <!-- Header -->
                <div class="text-center mb-4">
                    <!-- <img src="logo.png" onerror="this.style.display='none'" class="h-16 w-auto mx-auto mb-2" alt="Logo"> -->
                    <h1 class="text-2xl font-bold uppercase tracking-wide mb-1">Bangladesh Medical University</h1>
                    <p class="text-sm font-semibold">Shahbag, Dhaka-1000</p>
                    <div class="border-b-2 border-black mt-2 mb-1"></div>
                    <div class="border-b border-black"></div>
                </div>

                <!-- Patient Info Table -->
                <table class="layout-table">
                    <tr>
                        <td class="w-1/2"><b>Name:</b> <span id="out_name"></span></td>
                        <td class="w-1/2 text-right"><b>Age:</b> <span id="out_age"></span> <span class="ml-4"><b>Reg:</b> <span id="out_reg"></span></span></td>
                    </tr>
                    <tr>
                        <td><b>Admission date & time:</b> <span id="out_admDate"></span>; <span id="out_admTime"></span></td>
                        <td class="text-right"></td>
                    </tr>
                </table>

                <div class="font-bold border border-black px-2 bg-gray-100 text-center mb-2 w-full">Discharge Summary</div>

                <table class="layout-table">
                    <tr>
                        <td class="w-1/2"><b>BALAM:</b> <span id="out_balam"></span></td>
                        <td class="w-1/2 text-right"><b>Discharge date & time:</b> <span id="out_disDate"></span>; <span id="out_disTime"></span></td>
                    </tr>
                    <tr><td><b>SCANU:</b> <span id="out_scanu"></span></td><td></td></tr>
                    <tr><td><b>Address:</b> <span id="out_address"></span></td><td></td></tr>
                    <tr><td><b>Mother's Name:</b> <span id="out_mother"></span></td><td></td></tr>
                    <tr><td><b>Father's Name:</b> <span id="out_father"></span></td><td></td></tr>
                    <tr>
                        <td class="w-1/2"><b>Mobile Number:</b> <span id="out_mobile"></span></td>
                        <td class="w-1/2 text-right"><b>Bed Doctor:</b> <span id="out_bedDoctor"></span></td>
                    </tr>
                    <tr><td colspan="2"><div class="h-2"></div></td></tr>
                    <tr><td colspan="2"><b>Admitting Consultant:</b> <span id="out_consultant"></span></td></tr>
                    <tr><td colspan="2"><b>Diagnosis:</b> <span id="out_diagnosis"></span></td></tr>
                </table>

                <!-- Status Box -->
                <div class="border border-black p-2 mb-4">
                    <table class="layout-table">
                        <tr>
                            <td><b>Discharge Status:</b> <span id="out_disStatus"></span></td>
                            <td><b>Discharge Type:</b> <span id="out_disType"></span></td>
                        </tr>
                    </table>
                    <div class="border-t border-gray-400 pt-1 mt-1">
                        <table class="layout-table">
                            <tr>
                                <td><b>Wt:</b> <span id="out_disWeight"></span></td>
                                <td><b>Length:</b> <span id="out_disLength"></span></td>
                                <td><b>OFC:</b> <span id="out_disOFC"></span></td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- History -->
                <div class="mb-4">
                    <p class="font-bold underline mb-1">Brief Clinical History:</p>
                    <p id="out_history" class="text-justify whitespace-pre-wrap leading-snug"></p>
                </div>

                <!-- General Info -->
                <div class="border border-black mb-4">
                    <div class="bg-gray-100 font-bold text-center border-b border-black py-1">General Information:</div>
                    <div class="p-2">
                        <div class="font-bold underline mb-1">Baby: (During discharge)</div>
                        <table class="layout-table">
                            <tr>
                                <td><b>Color:</b> <span id="out_babyColor"></span></td>
                                <td><b>Reflex:</b> <span id="out_babyReflex"></span></td>
                                <td><b>CRT:</b> &lt;2 sec</td>
                            </tr>
                            <tr>
                                <td><b>Pulse:</b> <span id="out_pulse"></span></td>
                                <td><b>Resp:</b> <span id="out_resp"></span></td>
                                <td></td>
                            </tr>
                             <tr>
                                <td><b>Birth Wt:</b> <span id="out_birthWeight"></span></td>
                                <td><b>Blood Grp:</b> <span id="out_bloodGroup"></span></td>
                                <td></td>
                            </tr>
                        </table>
                        <div class="font-bold underline mb-1 mt-2">Mother:</div>
                        <table class="layout-table">
                            <tr>
                                <td><b>Age:</b> <span id="out_motherAge"></span></td>
                                <td><b>Blood Grp:</b> <span id="out_motherBlood"></span></td>
                                <td><b>Para:</b> <span id="out_motherPara"></span></td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Treatment -->
                <div class="mb-4">
                    <p class="font-bold underline mb-1">Treatment Summary:</p>
                    <p id="out_treatment" class="whitespace-pre-wrap ml-4"></p>
                </div>

                <!-- Investigation -->
                <div class="mb-6">
                    <p class="font-bold underline mb-2">Investigation:</p>
                    <div id="table-container"></div>
                </div>

                <!-- Advice -->
                <div class="mb-4">
                    <p class="font-bold underline mb-1">Advice/Recommendation:</p>
                    <div id="out_advice" class="p-2 rounded whitespace-pre-wrap bengali-text"></div>
                </div>

                <!-- OPD -->
                <div class="mb-6">
                    <p class="font-bold mb-1">OPD follow up visit:</p>
                    <p id="out_opd" class="bengali-text mb-4"></p>
                    <div class="border border-black p-2 inline-block">
                        <b>NICU Contact Number:</b> <span id="out_contact"></span>
                    </div>
                </div>

                <!-- Signatures -->
                <table class="layout-table" style="margin-top: 50px;">
                    <tr>
                        <td class="text-center w-1/3">
                            <p class="font-bold" id="out_prepBy"></p>
                            <div class="border-t border-black w-3/4 mx-auto mt-1"></div>
                            <p>Prepared by</p>
                        </td>
                        <td class="text-center w-1/3">
                            <p class="font-bold" id="out_checkBy"></p>
                            <div class="border-t border-black w-3/4 mx-auto mt-1"></div>
                            <p>Checked by</p>
                        </td>
                        <td class="text-center w-1/3">
                            <div class="h-4"></div>
                            <div class="border-t border-black w-3/4 mx-auto mt-1"></div>
                            <p>Consultant Sign</p>
                        </td>
                    </tr>
                </table>
                
                <div class="text-center text-[8px] text-gray-400 mt-8">Generated by NICU System â€¢ Bangladesh Medical University</div>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script>
        const logoBase64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKMAAADICAYAAACEX1EZAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAgAElEQVR42uy9d3xUdfb//5w+kynpjSSkEFoEBKQEKQq4NBuKBSurq6uuYltd2/4W3dVddUWx665lP/beKVIE6VVK6JBOeplker3398ckN5mUyQAhAb+ex4PHg8zMvfd93/d1T3md8z5vGb/J8csTkwzA+cBMYBogB5YBS4E1LFhr+22Sjl9kv01BWOADGNYEvJnABEDdya89wPomYC4H9rBg7W9z+BsYTwqAMcAFrbRfnxM8U3mT1vwRWMmCtfW/Te5vYOwKfEpgVCvwjWmyP/bN+s+P+0BswhJkABMAm8DkZ/1f20e4x4WqXQkAAAAASUVORK5CYII=';

        const fields = [
            'name', 'age', 'reg', 'admDate', 'admTime', 'disDate', 'disTime', 'balam', 'scanu', 'mobile',
            'address', 'mother', 'father', 'consultant', 'diagnosis', 'disStatus', 'disType', 
            'disWeight', 'disLength', 'disOFC', 'history', 'babyColor', 'babyReflex', 'pulse', 
            'resp', 'birthWeight', 'bloodGroup', 'motherAge', 'motherPara', 'treatment', 'advice', 
            'opd', 'contact', 'prepBy', 'checkBy', 'motherBlood', 'bedDoctor'
        ];

        // Auto-Save Functionality
        function saveData() {
            const data = {};
            fields.forEach(id => {
                const el = document.getElementById(`in_${id}`);
                if(el) data[id] = el.value;
            });
            data.table = tableData;
            localStorage.setItem('nicu_discharge_data', JSON.stringify(data));
        }

        function loadData() {
            const saved = localStorage.getItem('nicu_discharge_data');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    fields.forEach(id => {
                        if (data[id] !== undefined) {
                            const el = document.getElementById(`in_${id}`);
                            if(el) el.value = data[id];
                        }
                    });
                    if(data.table) tableData = data.table;
                } catch(e) { console.error("Load failed", e); }
            }
            renderAll();
            updatePreview();
        }

        function updatePreview() {
            fields.forEach(id => {
                const el = document.getElementById(`in_${id}`);
                const out = document.getElementById(`out_${id}`);
                if (el && out) out.innerText = el.value;

                // Add save trigger
                saveData();
            });

            // Special handling for Mother's Blood Group based on input or default logic
            const mBGrp = document.getElementById('out_motherBlood');
            if(mBGrp) {
                const inMB = document.getElementById('in_motherBlood');
                if (inMB && inMB.value) {
                    mBGrp.innerText = inMB.value;
                } else {
                    mBGrp.innerText = "";
                }
            }

            // Update HTML logo visibility
            const htmlLogo = document.getElementById('html-logo');
            if (htmlLogo) {
                // Assuming logo.png is in the same directory, it should load.
                // The onerror handles cases where it's not found.
                // We're just ensuring it's visible if it loads.
                htmlLogo.style.display = 'block'; 
            }
        }

        fields.forEach(id => {
            const el = document.getElementById(`in_${id}`);
            if(el) el.addEventListener('input', updatePreview);
        });

        // --- Table Logic ---
        let defaultTable = {
             headers: ["Date", "", "", "", "", "", "", "", ""],
             rows: [
                ["Hb (g/dl)", "", "", "", "", "", "", "", ""],
                ["TC (/cmm)", "", "", "", "", "", "", "", ""],
                ["N/L", "", "", "", "", "", "", "", ""],
                ["PLT", "", "", "", "", "", "", "", ""],
                ["CRP", "", "", "", "", "", "", "", ""],
                ["S. Creatinine", "", "", "", "", "", "", "", ""],
                ["Na+", "", "", "", "", "", "", "", ""],
                ["K+", "", "", "", "", "", "", "", ""]
            ]
        };

        let tableData = JSON.parse(JSON.stringify(defaultTable));

        let activeRow = -1;
        let activeCol = -1;

        function setActive(r, c) {
            activeRow = r;
            activeCol = c;

            // Update classes directly without re-rendering to preserve focus
            const table = document.getElementById('editor-table');
            if(!table) return;

            // Remove old highlights
            table.querySelectorAll('.bg-blue-200').forEach(el => el.classList.remove('bg-blue-200'));
            table.querySelectorAll('.bg-blue-50').forEach(el => el.classList.remove('bg-blue-50'));

            // Apply new highlights
            const rows = table.rows;
            // Highlight Column Header
            if (activeCol >= 0 && rows.length > 0) {
                 // The header row is rows[0]. Cells: 0=Corner, 1=Col1, ...
                 // So data col index i corresponds to cell index i+1
                 if (rows[0].cells[activeCol+1]) {
                     rows[0].cells[activeCol+1].classList.add('bg-blue-200');
                 }
            }

            // Iterate rows to highlight cells and row headers
            for (let i = 1; i < rows.length; i++) { // Skip header row
                const rowIdx = i - 1;
                const tr = rows[i];

                // Highlight Row Header (first cell)
                if (rowIdx === activeRow) {
                    if (tr.cells[0]) tr.cells[0].classList.add('bg-blue-200');
                }

                // Highlight Cells in Row or Col
                for (let j = 1; j < tr.cells.length; j++) {
                    const colIdx = j - 1;
                    if (rowIdx === activeRow || colIdx === activeCol) {
                        tr.cells[j].classList.add('bg-blue-50');
                    }
                }
            }
        }

        function renderEditorTable() {
            const table = document.getElementById('editor-table');
            table.innerHTML = '';
            const thead = document.createElement('tr');

            // Corner cell
            const thCorner = document.createElement('th');
            thCorner.className = "bg-gray-100 p-1 border";
            thead.appendChild(thCorner);

            tableData.headers.forEach((h, i) => {
                const th = document.createElement('th');
                th.className = "bg-gray-100 p-1 border";
                const inp = document.createElement('input');
                inp.value = h;
                inp.className = "w-full text-center bg-transparent font-bold";
                inp.oninput = e => { tableData.headers[i] = e.target.value; renderPreviewTable(); saveData(); };
                inp.onfocus = () => setActive(-1, i);
                th.appendChild(inp);
                thead.appendChild(th);
            });
            table.appendChild(thead);

            tableData.rows.forEach((row, r) => {
                const tr = document.createElement('tr');

                // Row Header (index)
                const thRow = document.createElement('td');
                thRow.className = "bg-gray-50 border text-center text-gray-400";
                thRow.innerText = r + 1;
                tr.appendChild(thRow);

                row.forEach((cell, c) => {
                    const td = document.createElement('td');
                    td.className = "p-0 border";
                    const inp = document.createElement('input');
                    inp.value = cell;
                    inp.className = "w-full p-1 text-center outline-none bg-transparent";
                    inp.oninput = e => { tableData.rows[r][c] = e.target.value; renderPreviewTable(); saveData(); };
                    inp.onfocus = () => setActive(r, c);
                    td.appendChild(inp);
                    tr.appendChild(td);
                });
                table.appendChild(tr);
            });

            // Restore highlight if active
            setActive(activeRow, activeCol);
        }

        function renderPreviewTable() {
            const container = document.getElementById('table-container');
            let html = '<table class="data-table"><thead><tr>';
            tableData.headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';
            tableData.rows.forEach(row => {
                html += '<tr>';
                row.forEach(cell => html += `<td>${cell}</td>`);
                html += '</tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderAll() {
            renderEditorTable();
            renderPreviewTable();
        }

        // Table controls
        function addRow() { tableData.rows.push(new Array(tableData.headers.length).fill("")); renderAll(); saveData(); }
        function addColumn() { tableData.headers.push("New"); tableData.rows.forEach(r => r.push("")); renderAll(); saveData(); }
        function deleteRow() {
            if(activeRow >= 0 && activeRow < tableData.rows.length) {
                tableData.rows.splice(activeRow, 1);
                activeRow = -1;
            } else if(tableData.rows.length) {
                tableData.rows.pop();
            }
            renderAll();
            saveData();
        }
        function deleteColumn() {
            if(activeCol >= 0 && activeCol < tableData.headers.length && tableData.headers.length > 1) {
                tableData.headers.splice(activeCol, 1);
                tableData.rows.forEach(r => r.splice(activeCol, 1));
                activeCol = -1;
            } else if(tableData.headers.length > 1) {
                tableData.headers.pop();
                tableData.rows.forEach(r => r.pop());
            }
            renderAll();
            saveData();
        }
        function clearTable() { if(confirm("Clear?")) { tableData.rows = [new Array(tableData.headers.length).fill("")]; renderAll(); saveData(); } }
        function newPatient() {
            if(confirm("Start New Patient? This will clear all data.")) {
                localStorage.removeItem('nicu_discharge_data');
                location.reload();
            }
        }
        function importTable() {
            const raw = document.getElementById('paste-area').value;
            if(!raw) return;
            const rows = raw.trim().split('\n').map(r => r.split('\t'));
            if(rows.length) {
                tableData.headers = rows[0];
                tableData.rows = rows.slice(1);
                // Padding
                tableData.rows.forEach(r => {
                    while(r.length < tableData.headers.length) r.push("");
                });
                renderAll();
                saveData();
                document.getElementById('paste-area').value = "";
            }
        }

        // --- SIMPLE HTML TO WORD EXPORT ---
        function exportHtmlToWord() {
            const preHtml = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Export HTML to Word Document with JavaScript</title>";

            // Inline critical CSS
            const styles = `
                <style>
                body { font-family: 'Times New Roman', serif; color: black; }
                table { border-collapse: collapse; width: 100%; }
                td, th { vertical-align: top; padding: 2px; }

                /* Replicate Layout Table */
                table.layout-table { width: 100%; margin-bottom: 5px; }
                table.layout-table td { border: none; vertical-align: top; padding: 2px; }

                /* Replicate Data Table */
                table.data-table { width: 100%; border: 1px solid black; font-size: 10px; margin-top: 5px; }
                table.data-table th, table.data-table td { border: 1px solid black; padding: 4px; text-align: center; }
                table.data-table th { background-color: #f3f4f6; font-weight: bold; }
                table.data-table td:first-child { text-align: left; font-weight: bold; }

                /* Helpers */
                .text-center { text-align: center; }
                .text-right { text-align: right; }
                .font-bold { font-weight: bold; }
                .underline { text-decoration: underline; }
                .text-xs { font-size: 10px; }
                .text-sm { font-size: 12px; }
                .text-2xl { font-size: 18pt; }
                .mb-1 { margin-bottom: 4px; }
                .mb-2 { margin-bottom: 8px; }
                .mb-4 { margin-bottom: 16px; }
                .border { border: 1px solid black; }
                .border-b { border-bottom: 1px solid black; }
                .border-t { border-top: 1px solid black; }
                .border-black { border-color: black; }
                .bg-gray-100 { background-color: #f3f4f6; }
                .uppercase { text-transform: uppercase; }

                /* Ensure image sizing */
                img { max-height: 80px; width: auto; }
                </style>
            `;

            const postHtml = "</head><body>";
            const footer = "</body></html>";

            // Clone the print area to avoid modifying the DOM
            const printArea = document.getElementById("print-area").cloneNode(true);

            // Fix images in the clone if they are hidden/onerror
            const imgs = printArea.querySelectorAll('img');
            imgs.forEach(img => {
                if (img.style.display === 'none') {
                    // If it was hidden (e.g. onerror), remove it or ensure it doesn't break
                    // We'll leave it as is or try to put the base64 source if we have it
                    img.src = logoBase64;
                    img.style.display = 'block';
                }
            });

            const html = preHtml + styles + postHtml + printArea.innerHTML + footer;

            const blob = new Blob(['\ufeff', html], {
                type: 'application/msword'
            });

            const name = document.getElementById('in_name').value.replace(/ /g,"_") || "Discharge_Summary";
            saveAs(blob, name + '.doc');
        }

        // --- NATIVE DOCX GENERATION ---
        async function generateDocx() {
            try {
                const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, AlignmentType, BorderStyle, ImageRun } = docx;

                const val = id => document.getElementById('in_'+id).value || "";

                // Convert Base64 Data URI to ArrayBuffer (Synchronous approach)
                const base64Data = logoBase64.split(',')[1];
                const binaryString = window.atob(base64Data);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const imageBuffer = bytes.buffer;

                // Helper to check for Bengali characters
                const isBengali = (text) => {
                    // Unicode range for Bengali script
                    return /[\u0980-\u09FF]/.test(text);
                };

                // Helper Styles
                const bold = (text, defaultFont = "Times New Roman", defaultSize = 24) => {
                    return [new TextRun({ text: text, bold: true, font: defaultFont, size: defaultSize })];
                };
                const normal = (text, defaultFont = "Times New Roman", defaultSize = 24) => {
                    if (!text) return [new TextRun({ text: "", font: defaultFont, size: defaultSize })]; // Ensure an array is always returned

                    const lines = text.split('\n');
                    const runs = [];
                    lines.forEach((line, index) => {
                        runs.push(new TextRun({
                            text: line,
                            font: isBengali(line) ? 'Noto Sans Bengali' : defaultFont,
                            size: defaultSize
                        }));
                        if (index < lines.length - 1) {
                            runs.push(new TextRun({ text: "", break: 1 })); // Add a line break
                        }
                    });
                    return runs;
                };

                const p = (children, align=AlignmentType.LEFT, spacingAfter = 100) => new Paragraph({ children: Array.isArray(children) ? children.flat() : [children], alignment: align, spacing: { after: spacingAfter } });

                // Helper for 2-column layout (invisible borders)
                const twoCol = (leftText, leftVal, rightText, rightVal) => new TableRow({
                    children: [
                        new TableCell({ children: [p([bold(leftText), ...normal(" " + leftVal)])], borders: noBorders, width: { size: 50, type: WidthType.PERCENTAGE } }),
                        new TableCell({ children: [p([bold(rightText), ...normal(" " + rightVal)])], borders: noBorders, width: { size: 50, type: WidthType.PERCENTAGE }, verticalAlign: "top" })
                    ]
                });
                const noBorders = { top: {style: BorderStyle.NONE}, bottom: {style: BorderStyle.NONE}, left: {style: BorderStyle.NONE}, right: {style: BorderStyle.NONE}, insideVertical: {style: BorderStyle.NONE}, insideHorizontal: {style: BorderStyle.NONE} };

                // Investigations Table Build
                const invHeaders = new TableRow({
                    children: tableData.headers.map(h => new TableCell({
                        children: [p([bold(h)], AlignmentType.CENTER, 0)], // Spacing after 0 for table cells
                        shading: { fill: "f3f4f6" }
                    }))
                });
                const invRows = tableData.rows.map(row => new TableRow({
                    children: row.map(cell => new TableCell({
                        children: [p([...normal(cell)], AlignmentType.CENTER, 0)] // Spacing after 0 for table cells
                    }))
                }));

                const doc = new Document({
                    sections: [{
                        properties: {
                            page: { margin: { top: 720, right: 720, bottom: 720, left: 720 } } // 0.5 inch margins
                        },
                        children: [
                            new Paragraph({ // Logo
                                alignment: AlignmentType.CENTER,
                                children: [
                                    new ImageRun({
                                        data: imageBuffer,
                                        transformation: {
                                            width: 100, // Adjust size as needed
                                            height: 100,
                                        },
                                    }),
                                ],
                            }),
                            // Header
                            new Paragraph({ children: [new TextRun({ text: "Bangladesh Medical University", bold: true, size: 48, font: "Times New Roman" })], alignment: AlignmentType.CENTER }), // Increased from 36 to 48 (24pt)
                            new Paragraph({ children: [new TextRun({ text: "Shahbag, Dhaka-1000", size: 28, font: "Times New Roman" })], alignment: AlignmentType.CENTER }), // Increased from 24 to 28 (14pt)
                            new Paragraph({ children: [], border: { bottom: { color: "000000", space: 1, style: "single", size: 6 } } }), // Line

                            p([], AlignmentType.LEFT, 0), // Spacer, with no spacing after

                            // Patient Info Table
                            new Table({
                                width: { size: 100, type: WidthType.PERCENTAGE },
                                borders: noBorders,
                                rows: [
                                    new TableRow({
                                        children: [
                                            new TableCell({ children: [p([bold("Name:"), ...normal(" " + val("name"))])], borders: noBorders, width: { size: 50, type: WidthType.PERCENTAGE } }),
                                            new TableCell({ children: [p([bold("Age:"), ...normal(" " + val("age")), ...normal("   Reg:"), ...normal(" " + val("reg"))])], borders: noBorders, width: { size: 50, type: WidthType.PERCENTAGE }, verticalAlign: "top" })
                                        ]
                                    }),
                                    new TableRow({
                                        children: [
                                            new TableCell({ children: [p([bold("Admission date & time:"), ...normal(" " + val("admDate") + "; " + val("admTime"))])], borders: noBorders }),
                                            new TableCell({ children: [p([])], borders: noBorders }), // Empty for alignment
                                        ]
                                    }),
                                ]
                            }),

                            // Discharge Summary Title Box
                            p([...bold("Discharge Summary", "Times New Roman", 36)], AlignmentType.CENTER, 200).addBorder({ top: {style: BorderStyle.SINGLE}, bottom: {style: BorderStyle.SINGLE}, left: {style: BorderStyle.SINGLE}, right: {style: BorderStyle.SINGLE} }).addShading({ fill: "f3f4f6" }),

                            new Table({
                                width: { size: 100, type: WidthType.PERCENTAGE },
                                borders: noBorders,
                                rows: [
                                    new TableRow({
                                        children: [
                                            new TableCell({ children: [p([bold("BALAM:"), ...normal(" " + val("balam"))])], borders: noBorders, width: { size: 50, type: WidthType.PERCENTAGE } }),
                                            new TableCell({ children: [p([bold("Discharge date & time:"), ...normal(" " + val("disDate") + "; " + val("disTime"))])], borders: noBorders, width: { size: 50, type: WidthType.PERCENTAGE }, verticalAlign: "top" })
                                        ]
                                    }),
                                    twoCol("SCANU:", val("scanu"), "", ""),
                                    twoCol("Address:", val("address"), "", ""),
                                    twoCol("Mother's Name:", val("mother"), "", ""),
                                    twoCol("Father's Name:", val("father"), "", ""),
                                    twoCol("Mobile Number:", val("mobile"), "Bed Doctor:", val("bedDoctor")),
                                ]
                            }),

                            p([bold("Admitting Consultant: "), ...normal(val("consultant"))]),
                            p([bold("Diagnosis: "), ...normal(val("diagnosis"))]),

                            // Status Box
                            new Table({
                                width: { size: 100, type: WidthType.PERCENTAGE },
                                rows: [
                                    new TableRow({ children: [
                                        new TableCell({ children: [p([bold("Discharge Status: "), ...normal(val("disStatus"))])], borders: noBorders }),
                                        new TableCell({ children: [p([bold("Discharge Type: "), ...normal(val("disType"))])], borders: noBorders })
                                    ]}),
                                    new TableRow({ children: [
                                        new TableCell({ children: [p([bold("Wt: "), ...normal(val("disWeight")), bold("  Length: "), ...normal(val("disLength")), bold("  OFC: "), ...normal(val("disOFC"))])], columnSpan: 2, borders: { top: {style: BorderStyle.SINGLE, color: "aaaaaa"} } })
                                    ]})
                                ],
                                borders: { top: {style: BorderStyle.SINGLE}, bottom: {style: BorderStyle.SINGLE}, left: {style: BorderStyle.SINGLE}, right: {style: BorderStyle.SINGLE} }
                            }),

                            p([bold("Brief Clinical History:"), ...normal("\n" + val("history"))]),

                            // General Info Table
                            p([bold("General Information:")], AlignmentType.LEFT, 200),
                            new Paragraph({ // Baby Section Title
                                children: [
                                    new TextRun({ text: "Baby: (During discharge)", bold: true, underline: {}, font: "Times New Roman", size: 24 }),
                                ],
                                spacing: { after: 100 }
                            }),
                            new Table({
                                width: { size: 100, type: WidthType.PERCENTAGE },
                                borders: noBorders, // Set default to no borders
                                rows: [
                                    new TableRow({
                                        children: [
                                            new TableCell({ children: [p([bold("Color:"), ...normal(" " + val("babyColor"))])], borders: noBorders }),
                                            new TableCell({ children: [p([bold("Reflex:"), ...normal(" " + val("babyReflex"))])], borders: noBorders }),
                                            new TableCell({ children: [p([bold("CRT:"), ...normal(" <2 sec")])], borders: noBorders }),
                                        ]
                                    }),
                                    new TableRow({
                                        children: [
                                            new TableCell({ children: [p([bold("Pulse:"), ...normal(" " + val("pulse"))])], borders: noBorders }),
                                            new TableCell({ children: [p([bold("Resp:"), ...normal(" " + val("resp"))])], borders: noBorders }),
                                            new TableCell({ children: [p([])], borders: noBorders }), // Empty cell
                                        ]
                                    }),
                                    new TableRow({
                                        children: [
                                            new TableCell({ children: [p([bold("Birth Wt:"), ...normal(" " + val("birthWeight"))])], borders: noBorders }),
                                            new TableCell({ children: [p([bold("Blood Grp:"), ...normal(" " + val("bloodGroup"))])], borders: noBorders }),
                                            new TableCell({ children: [p([])], borders: noBorders }), // Empty cell
                                        ]
                                    }),
                                ]
                            }),
                            new Paragraph({ // Mother Section Title
                                children: [
                                    new TextRun({ text: "Mother:", bold: true, underline: {}, font: "Times New Roman", size: 24 }),
                                ],
                                spacing: { before: 200, after: 100 }
                            }),
                            new Table({
                                width: { size: 100, type: WidthType.PERCENTAGE },
                                borders: noBorders, // Set default to no borders
                                rows: [
                                    new TableRow({
                                        children: [
                                            new TableCell({ children: [p([bold("Age:"), ...normal(" " + val("motherAge"))])], borders: noBorders }),
                                            new TableCell({ children: [p([bold("Blood Grp:"), ...normal(" " + val("motherBlood"))])], borders: noBorders }),
                                            new TableCell({ children: [p([bold("Para:"), ...normal(" " + val("motherPara"))])], borders: noBorders }),
                                        ]
                                    }),
                                ]
                            }),

                            p([bold("Treatment Summary:"), ...normal("\n" + val("treatment"))]),

                            // Investigations
                            p([bold("Investigations:")]),
                            new Table({
                                width: { size: 100, type: WidthType.PERCENTAGE },
                                rows: [invHeaders, ...invRows]
                            }),

                            p([bold("Advice:"), ...normal("\n" + val("advice"))]),
                            p([bold("OPD follow up visit:"), ...normal("\n" + val("opd"))]),

                            new Paragraph({ children: [bold("NICU Contact Number: "), ...normal(val("contact"))], border: { top: {style: BorderStyle.SINGLE}, bottom: {style: BorderStyle.SINGLE}, left: {style: BorderStyle.SINGLE}, right: {style: BorderStyle.SINGLE} }, spacing: {before: 200} }),

                            // Signatures
                            p([]),
                            new Table({
                                width: { size: 100, type: WidthType.PERCENTAGE },
                                borders: noBorders,
                                rows: [
                                    new TableRow({
                                        children: [
                                            new TableCell({ children: [p([...normal(val("prepBy"))], AlignmentType.CENTER, 0), p([...normal("Prepared by")], AlignmentType.CENTER, 0)], borders: { top: {style: BorderStyle.SINGLE} } }),
                                            new TableCell({ children: [p([...normal(val("checkBy"))], AlignmentType.CENTER, 0), p([...normal("Checked by")], AlignmentType.CENTER, 0)], borders: { top: {style: BorderStyle.SINGLE} } }),
                                            new TableCell({ children: [p([], AlignmentType.CENTER, 0), p([...normal("Consultant Sign")], AlignmentType.CENTER, 0)], borders: { top: {style: BorderStyle.SINGLE} } })
                                        ]
                                    })
                                ]
                            }),
                            new Paragraph({ // Footer
                                children: [
                                    ...normal("Generated by NICU System â€¢ Bangladesh Medical University", "Times New Roman", 16), // Smaller, gray text
                                ],
                                alignment: AlignmentType.CENTER,
                                spacing: { before: 800 } // Adjust spacing as needed
                            }),
                        ]
                    }]
                });

                Packer.toBlob(doc).then(blob => {
                    saveAs(blob, `Discharge_${val("name").replace(/ /g,"_")}.docx`);
                });
            } catch (error) {
                console.error("DOCX Generation Failed:", error);
                alert("Failed to generate DOCX. See console for details.\n" + error.message);
            }
        }

        lucide.createIcons();
        loadData(); // Load saved data or initialize defaults

        // Auto-expand textareas
        document.querySelectorAll('textarea').forEach(el => {
            el.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            // Initial sizing
            el.style.height = 'auto';
            el.style.height = (el.scrollHeight) + 'px';
        });
    </script>
</body>
</html>
